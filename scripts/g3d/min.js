/* Wed Jun 25 20:28:12 CST 2014 */
/* Generated by MagicCube MXBuild with MXFramework */
$ns("g3d.layer");$import("g3d.layer.Layer3D");
g3d.layer.FeatureLayer3D=function(){var b=$extend(g3d.layer.Layer3D),e={};b.color=16777215;e.init=b.init;b.init=function(a){e.init(a)};b.addCircle=function(a,c,d){if(!isNumber(c))throw Error("p_radius must be a number.");c=new THREE.CircleGeometry(c?c:2);d=b.translateMaterial(d,THREE.MeshBasicMaterial);d=new THREE.Mesh(c,d);a=b.translatePoint(a);d.position.copy(a);b.addObject(d);return d};b.addPolygon=function(a,c,d){if(!isNumber(c))throw Error("p_height must be a number.");c=c?c:1;a=b.translatePoints(a);
var f=null;if(2<a.length){if(f=new THREE.Shape(a),1>=f.curves.length)return null}else return null;a=new THREE.ExtrudeGeometry(f,{bevelEnabled:!1,amount:c});d=b.translateMaterial(d,THREE.MeshBasicMaterial);d=new THREE.Mesh(a,d);d.position.z=-c/2;b.addObject(d);return d};b.addSpline=function(a,c,d){a=a.getPoints(c);return b.addLineString(a,d)};b.addLineString=function(a,c){var d=new THREE.Geometry,f=b.translatePoints(a);d.vertices.addAll(f);f=b.translateMaterial(c,THREE.LineBasicMaterial);d=new THREE.Line(d,
f);b.addObject(d);return d};b.addPolyline=function(a,c){var d=a.clone();d.add(a[0]);return b.addLineString(d,c)};b.translatePoint=function(a){var c=isNumber(a.lon)&&isNumber(a.Lat),d=isArray(a)&&2===a.length,f=isNumber(a[0])&&isNumber(a[1]);if(isNumber(a.x)&&isNumber(a.y))return null==a.z&&(a.z=0),isPlainObject(a)||a.constructor===THREE.Vector2?new THREE.Vector3(a.x,a.y,a.z):a;if(c||d&&f)return b.scale.locationToVector3(a);throw Error(a+" is not a validate format of coordinate. A coordinate could be a LonLat, Vector2 or Vector3.");
};b.translatePoints=function(a){return a.map(function(a){return b.translatePoint(a)})};b.translateMaterial=function(a,c,d){var f=null;if(notEmpty(a))if(isPlainObject(a))d=$.extend({color:b.color},d),a=$.extend(d,a),f=new c(a);else if(isObject(a))f=a;else throw Error("p_material '"+a+"' can not be translated into Material.");else throw Error("p_material can not be null or empty");return f};return b.endOfClass(arguments)};g3d.layer.FeatureLayer3D.className="g3d.layer.FeatureLayer3D";$ns("g3d.layer");$import("mx3d.view.MXComponent3D");g3d.layer.Layer3D=function(){var b=$extend(mx3d.view.MXComponent3D),e={};b.scale=null;b.geoJSONUtil=null;b.onaddedtomap=null;null==b.onremovedfrommap;e.init=b.init;b.init=function(a){e.init(a)};return b.endOfClass(arguments)};g3d.layer.Layer3D.className="g3d.layer.Layer3D";$ns("g3d.layer");$import("g3d.layer.Layer3D");
g3d.layer.TileLayer3D=function(){function b(){if(!l){g.zoomMin=g.parentView.zoomMin;g.zoomMax=g.parentView.zoomMax;g.mapProvider=g.parentView.mapProvider;g.zoomInfo=g.parentView.zoomInfo;for(var b=g.zoomMin;b<=g.zoomMax;b++)b===g.zoomMin||b===g.zoomMax?c(b,4,4):c(b,3,3);d(g.zoomMin,g.parentView.zoom);g.parentView.on("zooming",a);l=!0}}function e(){l&&g.parentView.off("zooming",a)}function a(a){m?a.cancel=!0:d(a.zoomFrom,a.zoomTo)}function c(a,b,f){var c=g.zoomInfo[a],d=c.tileSize,d=new THREE.PlaneGeometry(2*
d*b+d,2*d*f+d);b=n(a,b,f);b.opacity=a===g.zoomMin?1:0;b=new THREE.Mesh(d,b);b.position=c.centerPosition;c.tileMesh=b;a===g.zoomMin&&g.addObject(c.tileMesh)}function d(a,b){m=!0;console.log("Zooming from "+a+" to "+b);var c=!1;a<b&&(c=!0,zoomOut=!1);for(var d=g.zoomMin+1;d<=g.zoomMax;d++)d>b?p(d,!c&&d===a,f):k(d,c&&d===b,f)}function f(){m=!1}function s(a,b,c){var f=g.zoomInfo[c].centerIndex;return{x:f.x+a,y:f.y-b,z:c}}function k(a,b,c){a=g.zoomInfo[a].tileMesh;g.addObject(a);b&&1!==a.material.opacity?
(new TWEEN.Tween(a.material)).to({opacity:1},400).onUpdate(function(){this.needsUpdate=!0}).onComplete(function(){isFunction(c)&&c()}).start():isFunction(c)&&c()}function p(a,b,c){var f=g.zoomInfo[a].tileMesh;b&&0!==f.material.opacity?(new TWEEN.Tween(f.material)).to({opacity:0},400).onUpdate(function(){this.needsUpdate=!0}).onComplete(function(){g.removeObject(f);isFunction(c)&&c()}).start():(g.removeObject(f),isFunction(c)&&c())}function n(a,b,c){var f=null,d=$format("{url:{0}, zoom:{1}, cols:{2}, rows:{3}}",
[g.mapProvider.urlFormat,a,b,c]),f=g.useLocalStorage?localStorage.getItem(d):null;if(null==f){var e=g.mapProvider.tileSize,k=document.createElement("canvas"),h=2*e*b+e,p=2*e*c+e;k.width=h;k.height=p;var l=new THREE.Texture(k);l.needsUpdate=!0;var f=new THREE.MeshBasicMaterial({map:l,transparent:!0}),m=k.getContext("2d");m.clearRect(0,0,h,p);k.loading=0;for(h=-c;h<=c;h++)for(var q=-b;q<=b;q++){var n=s(q,h,a);k.loading++;t(n,{index:n,a:q,b:h},function(a,f){m.drawImage(a,(f.a+b)*e,p-(f.b+c+1)*e,e,e);
l.needsUpdate=!0;k.loading--;0===k.loading&&g.useLocalStorage&&(localStorage.setItem(d,k.toDataURL("image/jpeg")),console.log("Saved tiles to cache. "+d))})}}else f=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(f),transparent:!0}),console.log("Load tiles from cache. "+d);return f}function h(a,b,c){var f=new Image;f.crossOrigin="anonymous";f.onload=function(a){f.onload=null;isFunction(c)&&c(f,b)};f.src=a}function t(a,b,f){a=g.mapProvider.getTileUrl(a);return h(a,b,f)}var g=$extend(g3d.layer.Layer3D),
r={};g.zoomMin=0;g.zoomMax=0;g.useLocalStorage=!1;g.mapProvider=null;g.zoomInfo=null;var l=!1,m=!1;r.init=g.init;g.init=function(a){r.init(a);g.on("addedtomap",b);g.on("removedfrommap",e)};return g.endOfClass(arguments)};g3d.layer.TileLayer3D.className="g3d.layer.TileLayer3D";$ns("g3d.map");
g3d.map.MapProvider=function(){var b=$extend(MXObject),e={};b.urlFormat="http://{s}.tiles.mapbox.com/v3/nicki.uxdh1tt9/{z}/{x}/{y}.png32";b.tileSize=256;e._=b._;b._=function(a){b.canConstruct()&&e._(a)};var a=0;b.getTileUrl=function(c){a++;4<=a&&(a=1);return $format(b.urlFormat,{x:c.x,y:c.y,z:c.z,s:["a","b","c"][a-1],n:a})};b.getTileIndex=function(a,b,f){null==f&&(f=!1);var e=Math.pow(2,b);a={x:(a.lon+180)/360*e,y:(1-Math.log(Math.tan(a.lat*Math.PI/180)+1/Math.cos(a.lat*Math.PI/180))/Math.PI)/2*e,
z:b};f||(a.x=Math.floor(a.x),a.y=Math.floor(a.y));return a};b.getTileLonLat=function(a){var b=Math.pow(2,a.z),f=Math.PI-2*Math.PI*a.y/b;return{lon:360*(a.x/b)-180,lat:180/Math.PI*Math.atan(0.5*(Math.exp(f)-Math.exp(-f)))}};return b.endOfClass(arguments)};g3d.map.MapProvider.className="g3d.map.MapProvider";$ns("g3d.map");
g3d.map.MapScale=function(){var b=$extend(MXObject),e={};b.centerLocation={lon:0,lat:0};b.zoomMin=0;b.zoomMax=0;b.zoomInfo=null;b.mapProvider=null;e._=b._;b._=function(a){b.canConstruct()&&e._(a)};b.locationToPoint=function(a){var c=g3d.util.GeoJSONUtil.normalizeLocation(a);if(null!=c){a=b.zoomInfo[b.zoomMax].centerIndex;var d=b.zoomInfo[b.zoomMax].centerPosition,c=b.mapProvider.getTileIndex(c,b.zoomMax,!0);return{x:d.x+(c.x-a.x)*b.mapProvider.tileSize-b.mapProvider.tileSize/2,y:d.y-(c.y-a.y)*b.mapProvider.tileSize+
b.mapProvider.tileSize/2}}return null};b.locationsToPoints=function(a){return a.map(function(a){return b.locationToPoint(a)})};b.locationToVector3=function(a){return null!=g3d.util.GeoJSONUtil.normalizeLocation(a)?(a=b.locationToPoint(a),new THREE.Vector3(a.x,a.y,0)):null};b.locationsToPath=function(a){return a.map(function(a){return b.locationToVector3(a)})};b.locationsToLine=function(a){a=b.locationsToPath(a);var c=new THREE.Geometry;c.vertices.addAll(a);return new THREE.Line(c)};b.locationsToSplinePath=
function(a,c){var d=b.locationsToPath(a);return d=(new THREE.SplineCurve3(d)).getPoints(c)};b.locationsToSpline=function(a,c){var d=b.locationsToSplinePath(a,c),f=new THREE.Geometry;f.vertices.addAll(d);return new THREE.Line(f)};return b.endOfClass(arguments)};g3d.map.MapScale.className="g3d.map.MapScale";$ns("g3d.util");
g3d.util.GeoJSONUtil=function(){var b=$extend(MXObject),e={};b.scale=null;e._=b._;b._=function(a){if(b.canConstruct()&&(e._(a),!$instanceof(b.scale,g3d.map.MapScale)))throw Error("constructor param 'scale' must be an instance of g3d.map.MapScale.");};b.parse=function(a){if("FeatureCollection"===a.type)return b.createFromFeatureCollection(a);if("Feature"===a.type)return b.createFromFeature(a);if("LineString"===a.type||"Polygon"===a.type)return b.createFromGeometry(a);throw Error("GeoJSON type '"+a.type+
"' has not been supported yet.");};b.createFromFeatureCollection=function(a){if("FeatureCollection"!==a.type)throw Error("The type of p_featureCollection must be FeatureCollection.");var c=[];a.features.forEach(function(a){a=b.createFromFeature(a);null!=a&&c.add(a)});return c};b.createFromFeature=function(a){if("Feature"!==a.type)throw Error("The type of p_feature must be Feature.");return b.createFromGeometry(a.geometry)};b.createFromGeometry=function(a){if("LineString"!==a.type&&"Polygon"!==a.type)throw Error("The type of p_geometry must be LineString or Polygon.");
var c=null;"Polygon"===a.type?c=b.createShapeFromCoordinates(a.coordinates):"LineString"===a.type&&(c=b.createLineFromCoordinates(a.coordinates));return c};b.createLineFromCoordinates=function(a){var c=null;a=b.scale.locationsToPoints(a);1<a.length&&(c=new THREE.Geometry,a.forEach(function(a){c.vertices.add(new THREE.Vector3(a.x,a.y,0))}));return c};b.createShapeFromCoordinates=function(a){var c=null;a=b.scale.locationsToPoints(a[0]);return 2<a.length?(c=new THREE.Shape(a),1<c.curves.length?c:null):
null};return b.endOfClass(arguments)};g3d.util.GeoJSONUtil.className="g3d.util.GeoJSONUtil";g3d.util.GeoJSONUtil.normalizeLocation=function(b){if(isArray(b))return{lon:b[0],lat:b[1]};if(isPlainObject(b)){if(null!=b.lon&&null!=b.lat)return b;if(null!=b.lng&&null!=b.lat)return{lon:b.lng,lat:b.lat}}};$ns("g3d.view");$import("lib.transit.transit");$import("mx3d.view.AnimatedScene3DView");$import("g3d.util.GeoJSONUtil");$import("g3d.layer.FeatureLayer3D");$import("g3d.layer.TileLayer3D");$import("g3d.map.MapScale");$import("g3d.map.MapProvider");$import("g3d.view.ToolBarView");$include("g3d.res.MapScene3DView.css");
g3d.view.MapScene3DView=function(){function b(b){var c=b,c=b<a.zoomMin?a.zoomMin:b>a.zoomMax?a.zoomMax:b;return Math.pow(2,a.zoomMax-c+1)*a.mapProvider.tileSize}function e(b){for(var c=a.zoomMin;c<a.zoomMax;c++)if(b>=a.zoomInfo[c].cameraZ)return c;return a.zoomMax}var a=$extend(mx3d.view.AnimatedScene3DView);a.cameraParams={fov:60,near:100,far:1E6,position:{}};a.cameraControlsEnabled=!0;a.statsVisible=!1;var c={};a.centerLocation={lon:0,lat:0};a.zoom=12;a.zoomMin=11;a.zoomMax=15;a.displayCompass=
!0;a.landMesh=null;a.layers=[];a.materials={};a.mapProvider=null;a.scale=null;a.geoJSONUtil=null;a.zoomInfo=[];a.displayToolBar=!0;a.toolBarView=null;a.toolButtons=[{id:"anaglyph",autoCheck:!0},{id:"rotate",autoCheck:!0},{id:"view",autoCheck:!0},{id:"zoomIn"},{id:"zoomOut"}];a.onzooming=null;var d=a.onzoomed=null;c.init=a.init;a.init=function(b){a.initMapProvider();c.init(b);a.$element.addClass("MapScene3DView");a.setCenterLocation(a.centerLocation);a.initScale();a.initMaterials();a.displayCompass&&
a.initCompass();a.displayToolBar&&a.initToolBarView();a.landMesh=new THREE.Object3D;a.addObject(a.landMesh);a.initLayers()};a.setCenterLocation=function(b){a.centerLocation=g3d.util.GeoJSONUtil.normalizeLocation(b);a.initZoomInfo()};c.initScene=a.initScene;a.initScene=function(){c.initScene();var b=Math.pow(20-a.zoomMax,2)/2;a.scene.fog=new THREE.FogExp2(0,b/1E5)};c.initCamera=a.initCamera;a.initCamera=function(){null==a.cameraParams.position||null==a.cameraParams.position.z?a.cameraParams.position.z=
b(a.zoom):null!=a.cameraParams.position.z&&(a.zoom=e(a.cameraParams.position.z));c.initCamera()};a.initCameraControls=function(){a.cameraControlsEnabled&&null==a.cameraControls&&(a.cameraControls=new THREE.TrackballControls(a.camera,a.$element.find("canvas")[0]),a.cameraControls.minDistance=b(a.zoomMax)/1.2,a.cameraControls.maxDistance=1.2*b(a.zoomMin))};a.initCompass=function(){d=$("\x3cimg id\x3dcompass src\x3d'"+mx.getResourcePath("g3d.res.images.compass","png")+"'\x3e");a.$container.append(d);
d.on("click",function(){a.resetCamera()})};a.initToolBarView=function(){a.toolBarView=new g3d.view.ToolBarView({elementStyle:{position:"absolute"},id:"toolBar",buttons:a.toolButtons});a.addSubview(a.toolBarView);a.toolBarView.setFrame({left:0,top:(window.innerHeight-48*a.toolButtons.length)/2});a.toolBarView.on("buttonclick",a.ontoolbuttonclick)};a.initMaterials=function(){};a.ontoolbuttonclick=function(b){switch(b.id){case "anaglyph":a.anaglyphEffectEnabled=b.button.checked;break;case "rotate":a.cameraControls.controlMode=
b.button.checked?"rotate":"auto";break;case "view":a.resetCamera(null,b.button.checked);break;case "zoomIn":a.zoomIn();break;case "zoomOut":a.zoomOut()}};a.initMapProvider=function(){null===a.mapProvider&&(a.mapProvider=new g3d.map.MapProvider)};a.initZoomInfo=function(){for(var c=a.zoomMax;c>=a.zoomMin;c--){var d=null;c===a.zoomMax?(d=a.mapProvider.getTileIndex(a.centerLocation,a.zoomMax,!0),d={x:-(d.x-Math.floor(d.x)-0.5)*a.mapProvider.tileSize,y:(d.y-Math.floor(d.y)-0.5)*a.mapProvider.tileSize,
z:-0.5}):(d=a.zoomInfo[c+1].centerIndex,d={x:a.zoomInfo[c+1].centerPosition.x+(0===d.x%2?1:-1)*a.zoomInfo[c+1].tileSize/2,y:a.zoomInfo[c+1].centerPosition.y+(0===d.y%2?-1:1)*a.zoomInfo[c+1].tileSize/2,z:c-a.zoomMax+a.zoomInfo[a.zoomMax].centerPosition.z});d={zoom:c,centerIndex:a.mapProvider.getTileIndex(a.centerLocation,c),centerPosition:d,tileSize:Math.pow(2,a.zoomMax-c)*a.mapProvider.tileSize,cameraZ:b(c)};a.zoomInfo[c]=d}};a.initScale=function(){a.scale=new g3d.map.MapScale({mapProvider:a.mapProvider,
zoomInfo:a.zoomInfo,zoomMin:a.zoomMin,zoomMax:a.zoomMax});a.geoJSONUtil=new g3d.util.GeoJSONUtil({scale:a.scale})};a.initLayers=function(){if(0<a.layers.length){var b=a.layers.clone();a.layers.clear();b.forEach(function(b){a.addLayer(b)})}};c.update=a.update;a.update=function(b){c.update(b);null!=a.camera&&(a.updateZooming(b),a.updateLayers(b),a.updateCompass(b))};a.updateZooming=function(b){b=e(a.camera.position.z);if(b!==a.zoom){var c=a.zoom,d={zoomFrom:c,zoomTo:b,cancel:!1};a.trigger("zooming",
d);d.cancel||(a.zoom=b,a.trigger("zoomed",{zoomFrom:c,zoomTo:b}))}};a.updateLayers=function(b){a.layers.forEach(function(a){a.needsUpdate&&a.update(b)})};a.updateCompass=function(b){null!=d&&(b=Math.round(180*a.camera.rotation.z/Math.PI),d.css("webkitTransform","rotate("+b+"deg)"))};a.setZoom=function(c,d){var e=c;e>a.zoomMax?e=a.zoomMax:e<a.zoomMin&&(e=a.zoomMin);!1===d?a.camera.position.z=b(e):(e={x:0,y:0,z:b(e)},a.moveCamera(e,{x:0,y:0,z:0},500))};a.zoomIn=function(b){var c=1;null!=b&&(c=Math.abs(b));
a.setZoom(a.zoom+c);null!=a.toolBarView&&a.toolBarView.setButtonCheckState("view",!1)};a.zoomOut=function(b){var c=1;null!=b&&(c=Math.abs(b));a.setZoom(a.zoom-c);null!=a.toolBarView&&a.toolBarView.setButtonCheckState("view",!1)};a.addLayer=function(b){if(!$instanceof(b,g3d.layer.Layer3D))throw Error("p_layer must be an instance of g3d.view.Layer3D");a.layers.add(b);null!=b.id&&(a.layers[b.id]=b);var c=a.landMesh;c.add(b.object3D);$.extend(b,{parentView:a,parentObject3D:c,scale:a.scale,geoJSONUtil:a.geoJSONUtil});
b.trigger("addedtomap")};a.removeLayer=function(b){if(!$instanceof(b,g3d.layer.Layer3D))throw Error("p_layer must be an instance of g3d.view.Layer3D");a.layers.remove(b);null!=b.id&&delete a.layers[b.id];a.landMesh.remove(b.object3D);b.trigger("removedfrommap")};a.resetCamera=function(b,c){if(null!=a.cameraControls){var d=null,e=null,n=null!=b?b:2E3;if(c)d={x:-50.9760365348891,y:-1750.5946134789813,z:2470.697634926914},e={x:0.6164362891923738,y:-0.01683316387367657,z:0.01192588582967832};else{var h=
a.cameraParams,d={x:0,y:0,z:0},e={x:0,y:0,z:0};isArray(h.position)?(d.x=h.position[0],d.y=h.position[1],d.z=h.position[2]):d=$.extend(d,h.position)}null!=a.toolBarView&&a.toolBarView.setButtonCheckState("view",!0===c);return a.moveCamera(d,e,n)}return null};return a.endOfClass(arguments)};g3d.view.MapScene3DView.className="g3d.view.MapScene3DView";$ns("g3d.view");$include("g3d.res.ToolBarView.css");
g3d.view.ToolBarView=function(){function b(a){a=a.currentTarget.id;var b=e.buttons[a];b.autoCheck&&e.setButtonCheckState(a,!b.checked);e.trigger("buttonclick",{id:a,button:b})}var e=$extend(mx.view.View);e.elementClass="ToolBarView";e.elementTag="ul";var a={};e.buttons=[];e.onbuttonclick=null;a.init=e.init;e.init=function(c){a.init(c);0<e.buttons.length&&(c=e.buttons.clone(),e.buttons.clear(),e.addButtons(c));e.$container.on("click","li",b)};e.addButton=function(a){var b=a.id;if(null==b)throw Error("Button ID can not be empty or null.");
a=$.extend({autoCheck:!1,checked:!1,text:"",type:"button"},a);var f=$("\x3cli/\x3e");f.addClass("button");f.attr("id",b);a.checked&&f.addClass("checked");f.text(a.text);a.$element=f;e.$container.append(f);e.buttons.add(a);return e.buttons[a.id]=a};e.addButtons=function(a){a.forEach(function(a){e.addButton(a)})};e.removeButton=function(a){var b=e.buttons[a];null!=b&&(e.buttons.remove(b),delete e.buttons[a])};e.setButtonText=function(a,b){var f=e.buttons[a];null!=f&&(f.text=b,f.$element.text(b))};e.setButtonCheckState=
function(a,b){var f=e.buttons[a];null!=f&&(f.checked=b,f.checked?f.$element.addClass("checked"):f.$element.removeClass("checked"))};return e.endOfClass(arguments)};g3d.view.ToolBarView.className="g3d.view.ToolBarView";